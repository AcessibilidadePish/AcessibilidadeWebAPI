#!/bin/bash

# Detectar se est√° no Windows e usar PowerShell se necess√°rio
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]] || [[ -n "$WINDIR" ]]; then
    echo "ü™ü Detectado Windows - usando PowerShell..."
    powershell.exe -ExecutionPolicy Bypass -File ".git/hooks/pre-push.ps1"
    exit $?
fi

echo "üîç Git Pre-Push Hook - AcessibilidadeWebAPI"
echo "=========================================="

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üì¶ Executando build do projeto...${NC}"

# Executar build do projeto principal
dotnet build AcessibilidadeWebAPI/AcessibilidadeWebAPI.csproj --configuration Release --no-restore

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: Build do projeto principal falhou!${NC}"
    echo -e "${RED}‚ùå Push cancelado. Corrija os erros de compila√ß√£o antes de continuar.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Build do projeto principal: SUCESSO${NC}"

# Executar build do projeto de testes
echo -e "${BLUE}üß™ Executando build do projeto de testes...${NC}"

dotnet build AcessibilidadeWebAPI.Tests/AcessibilidadeWebAPI.Tests.csproj --configuration Release --no-restore

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: Build do projeto de testes falhou!${NC}"
    echo -e "${RED}‚ùå Push cancelado. Corrija os erros de compila√ß√£o nos testes.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Build do projeto de testes: SUCESSO${NC}"

# Executar testes
echo -e "${BLUE}üî¨ Executando testes...${NC}"

dotnet test AcessibilidadeWebAPI.Tests --configuration Release --no-build --verbosity minimal

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: Alguns testes falharam!${NC}"
    echo -e "${RED}‚ùå Push cancelado. Corrija os testes que est√£o falhando.${NC}"
    echo -e "${YELLOW}üí° Dica: Execute 'dotnet test --verbosity normal' para ver detalhes dos erros${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Todos os testes: SUCESSO${NC}"

# Validar especificamente os testes da corre√ß√£o DataConclusao
echo -e "${BLUE}üéØ Validando corre√ß√£o DataConclusao...${NC}"

dotnet test AcessibilidadeWebAPI.Tests --filter "DataConclusao" --configuration Release --no-build --verbosity minimal

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: Testes da corre√ß√£o DataConclusao falharam!${NC}"
    echo -e "${RED}‚ùå Push cancelado. A corre√ß√£o principal est√° com problemas.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Corre√ß√£o DataConclusao: VALIDADA${NC}"

# Sucesso final
echo ""
echo -e "${GREEN}üéâ PRE-PUSH VALIDATION: SUCESSO TOTAL!${NC}"
echo -e "${GREEN}‚úÖ Build: OK${NC}"
echo -e "${GREEN}‚úÖ Testes: OK${NC}"
echo -e "${GREEN}‚úÖ Corre√ß√£o DataConclusao: OK${NC}"
echo ""
echo -e "${BLUE}üöÄ Push autorizado! C√≥digo est√° pronto para produ√ß√£o.${NC}"
echo ""

exit 0 